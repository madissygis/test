<!DOCTYPE html>
<html>
<head>
    <title>ProxyObject Scope Leak Detection</title>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting ProxyObject scope detection...");

            const base = {
                foo() { return "original"; }
            };

            let callCount = 0;

            const handler = {
                get(target, prop, receiver) {
                    if (callCount++ > 10) {
                        // Avoid stack overflow
                        log("Breaking recursion after 10 calls");
                        return undefined;
                    }

                    log("Proxy 'get' called (" + callCount + ")");
                    log("prop = " + prop);

                    // Log receiver info
                    log("Receiver = " + receiver);
                    log("Receiver.constructor = " + receiver?.constructor);
                    log("Receiver.toString() = " + receiver?.toString());

                    // Try inspecting properties
                    try {
                        log("Receiver hasOwnProperty('foo') = " + receiver.hasOwnProperty("foo"));
                    } catch (e) {
                        log("Error checking hasOwnProperty: " + e.message);
                    }

                    // Try leaking something?
                    if (receiver && typeof receiver === "object") {
                        for (let key in receiver) {
                            try {
                                log(`receiver.${key} = ${receiver[key]}`);
                            } catch (e) {
                                log(`Error reading receiver.${key}: ${e.message}`);
                            }
                        }
                    }

                    return Reflect.get(...arguments);
                }
            };

            const proxy = new Proxy(base, handler);

            (function () {
                with (proxy) {
                    try {
                        foo(); // Should trigger Proxy 'get'
                    } catch (e) {
                        log("Exception in with-block: " + e.message);
                    }
                }
            })();
        };
    </script>
</head>
<body>
    <h2>ProxyObject Scope Leak Test v2</h2>
    <p>Detecting potential JSScope leaks via Proxy traps with controlled recursion.</p>
</body>
</html>
