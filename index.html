<!DOCTYPE html>
<html>
<head>
    <title>Blind Leak Detection via Proxy</title>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting blind leak detection...");

            const base = {};

            let callCount = 0;

            const handler = {
                get(target, prop, receiver) {
                    if (callCount++ > 5) {
                        log("Breaking recursion after 5 calls");
                        return undefined;
                    }

                    log("Proxy 'get' called (" + callCount + ")");
                    log("prop = " + prop);

                    // Try to deeply inspect receiver
                    try {
                        log("Receiver = " + receiver);
                        log("Receiver.constructor = " + receiver?.constructor?.name);

                        // Try enumerating all keys
                        const seen = new Set();
                        const stack = [receiver];

                        while (stack.length > 0) {
                            const obj = stack.pop();
                            try {
                                for (let key of Reflect.ownKeys(obj)) {
                                    if (!seen.has(key)) {
                                        seen.add(key);
                                        log(`Discovered key: ${key} (typeof: ${typeof key})`);
                                        try {
                                            const val = Reflect.get(obj, key, receiver);
                                            log(`  value typeof: ${typeof val}`);
                                        } catch (e) {
                                            log(`  error reading value: ${e.message}`);
                                        }
                                        if (typeof obj === "object" && obj !== null) {
                                            stack.push(Object.getPrototypeOf(obj));
                                        }
                                    }
                                }
                            } catch (e) {
                                log("Error enumerating keys: " + e.message);
                            }
                        }
                    } catch (e) {
                        log("Error inspecting receiver: " + e.message);
                    }

                    return Reflect.get(...arguments);
                }
            };

            const proxy = new Proxy(base, handler);

            (function () {
                with (proxy) {
                    try {
                        log("Accessing 'toString'...");
                        toString(); // Trigger Proxy trap
                    } catch (e) {
                        log("Exception in with-block: " + e.message);
                    }
                }
            })();
        };
    </script>
</head>
<body>
    <h2>Blind Leak Detection via Proxy Enumeration</h2>
    <p>Trying to detect internal scope leaks via property enumeration.</p>
</body>
</html>
