<!DOCTYPE html>
<html>
<head>
    <title>ProxyObject Scope Leak PoC</title>
    <script>
        function log(msg) {
            document.body.innerHTML += msg + "<br>";
        }

        window.onload = () => {
            log("Starting ProxyObject scope leak test...");

            // Dummy object to use in 'with' block
            const base = {
                foo() { return "original"; }
            };

            // Proxy handler to capture 'this'
            const handler = {
                get(target, prop, receiver) {
                    log("Proxy 'get' called");
                    log("Receiver constructor: " + receiver?.constructor?.name);
                    log("Receiver toString(): " + receiver?.toString());

                    // If receiver is a JSScope, we might be leaking internal pointer
                    if (receiver && typeof receiver === "object") {
                        try {
                            // Try converting to string or inspecting properties
                            log("Receiver hasOwnProperty('foo'): " + receiver.hasOwnProperty("foo"));
                        } catch (e) {
                            log("Error inspecting receiver: " + e.message);
                        }
                    }

                    return target[prop];
                }
            };

            const proxy = new Proxy(base, handler);

            // Run code inside 'with' block to trigger JSScope behavior
            (function () {
                with (proxy) {
                    try {
                        let result = foo(); // Should trigger Proxy 'get'
                        log("foo() returned: " + result);
                    } catch (e) {
                        log("Exception in with-block: " + e.message);
                    }
                }
            })();
        };
    </script>
</head>
<body>
    <h2>ProxyObject Scope Leak Test</h2>
    <p>Detecting potential JSScope leaks via Proxy traps.</p>
</body>
</html>
